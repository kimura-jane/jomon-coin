
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JOMON COIN | Claim & Tools</title>
<style>
  :root { --bg:#0b0d10; --fg:#e9eef2; --muted:#9aa7b1; --acc:#7bd389; --err:#ff7b7b; --warn:#f5c451;}
  html,body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--fg); }
  header { padding:18px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #1a1f24;}
  header img { width:36px; height:36px; border-radius:8px; background:#fff0; }
  h1 { font-size:18px; margin:0; letter-spacing:.5px; }
  main { max-width:900px; margin:0 auto; padding:18px; display:grid; gap:14px; }
  .card { border:1px solid #1a1f24; border-radius:12px; padding:16px; background:#0f1317; }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, input { font-size:15px; padding:10px 12px; border-radius:10px; border:1px solid #1a1f24; background:#141a1f; color:var(--fg); }
  button { cursor:pointer; }
  button.primary { background:var(--acc); color:#0a0f0c; border-color:#2e4735; font-weight:700; }
  button[disabled] { opacity:.5; cursor:not-allowed; }
  input { background:#0d1115; min-width:280px; }
  .muted { color:var(--muted); font-size:13px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .ok { color:#7bd389; } .warn{ color:var(--warn);} .err{ color:var(--err);}
  .grid { display:grid; gap:12px; }
  footer { padding:28px 16px; color:var(--muted); font-size:12px; text-align:center;}
  code { background:#0b0f12; padding:2px 6px; border-radius:6px; border:1px solid #1a1f24;}
  a { color:#8bd9ff; text-decoration:none } a:hover{text-decoration:underline}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
</head>
<body>
<header>
  <img src="./jomon-coin-logo-256.png" alt="JOMON" />
  <h1>JOMON COIN – Claim & Tools</h1>
</header>

<main>
  <div class="card grid" id="cfg">
    <div>ネットワーク: <b>Polygon PoS</b> <span class="muted">(ChainID 137)</span></div>
    <div>オーナー: <span id="ownerAddr" class="mono"></span></div>
    <div>トークン: <span id="tokenAddr"></span></div>
    <div id="distRow">ディストリビュータ: <span id="distAddr"></span></div>
    <div class="muted">※ トークンは <code>0x…(42文字)</code> の<strong>コントラクトアドレス</strong>を入れろ。ウォレットとは別物。</div>
  </div>

  <div class="card grid">
    <div class="row">
      <button id="connectBtn" class="primary">① ウォレット接続</button>
      <button id="switchBtn">② Polygonに切替</button>
      <button id="balanceBtn">残高表示</button>
      <div id="acct" class="mono muted"></div>
    </div>
    <div id="netStatus" class="muted"></div>
    <div id="balance" class="muted"></div>
  </div>

  <div class="card grid">
    <div>MetaMaskにJOMONを追加（ロゴ表示つき）</div>
    <div class="row">
      <button id="watchBtn">MetaMaskに追加</button>
      <div class="muted">ロゴ: <code>./jomon-coin-logo-256.png</code>（256×256 PNG）</div>
    </div>
  </div>

  <div class="card grid" id="claimCard">
    <div class="row">
      <button id="loadBtn">配布データ読込</button>
      <button id="claimBtn" disabled class="primary">Claim 実行</button>
      <div id="claimStat" class="muted"></div>
    </div>
    <div class="muted">同フォルダに <code>claims.json</code> を置く（スキーマは下記）。</div>
    <pre class="muted" style="white-space:pre-wrap;word-break:break-word;">
{
  "chainId": 137,
  "token": "0xYOUR_TOKEN_ADDRESS",
  "distributor": "0xYOUR_DISTRIBUTOR_ADDRESS",
  "claims": {
    "0xabc...": { "amount": "1", "proof": ["0x...", "0x..."] }
  }
}
    </pre>
  </div>

  <div class="card grid">
    <div>本人移行（migrate）</div>
    <div class="row">
      <input id="newAddr" placeholder="新アドレス (0x…)" />
      <button id="migrateBtn">migrate 実行</button>
    </div>
    <div class="muted">接続中アドレスの残高を <code>burn → new</code> に同量 <code>mint</code>。転送禁止の例外。</div>
    <div id="migStat" class="muted"></div>
  </div>
</main>

<footer>© JOMON COIN – 転送不可・譲渡不可・投機性なし</footer>

<script>
(async function(){
  const OWNER_ADDRESS = "0x8242dAe5C6fF90b03d15C54Cad95C3ed97AC0571";
  const TOKEN_ADDRESS = "";
  const DISTRIBUTOR_ADDRESS = "";
  const TOKEN_SYMBOL = "JOMON";
  const TOKEN_DECIMALS = 0;
  const TOKEN_IMAGE = "./jomon-coin-logo-256.png";
  const POLYGON = { chainId: "0x89", chainName: "Polygon PoS",
    nativeCurrency: { name: "POL", symbol: "POL", decimals: 18 },
    rpcUrls: ["https://polygon-rpc.com"],
    blockExplorerUrls: ["https://polygonscan.com/"]
  };

  const ERC20_MIN_ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function migrate(address newAddr) external"
  ];
  const DIST_ABI = [
    "function isClaimed(address) view returns (bool)",
    "function claim(uint256 amount, bytes32[] calldata proof) external"
  ];

  const $ = (id)=>document.getElementById(id);
  const connectBtn = $("connectBtn"), switchBtn=$("switchBtn"),
        balanceBtn=$("balanceBtn"), acctEl=$("acct"), netStatus=$("netStatus"), balEl=$("balance");
  const watchBtn=$("watchBtn");
  const loadBtn=$("loadBtn"), claimBtn=$("claimBtn"), claimStat=$("claimStat"), claimCard=$("claimCard");
  const migrateBtn=$("migrateBtn"), newAddr=$("newAddr"), migStat=$("migStat");

  const isAddr = (v)=>/^0x[a-fA-F0-9]{40}$/.test(v);
  $("ownerAddr").innerHTML = `<a class="mono" href="https://polygonscan.com/address/${OWNER_ADDRESS}" target="_blank" rel="noopener">${OWNER_ADDRESS}</a>`;

  if (isAddr(TOKEN_ADDRESS)) {
    $("tokenAddr").innerHTML = `<a class="mono" href="https://polygonscan.com/address/${TOKEN_ADDRESS}" target="_blank" rel="noopener">${TOKEN_ADDRESS}</a>`;
  } else {
    $("tokenAddr").innerHTML = `<span class="err">未設定（トークンの0x…を入れろ）</span>`;
  }
  if (isAddr(DISTRIBUTOR_ADDRESS)) {
    $("distAddr").innerHTML = `<a class="mono" href="https://polygonscan.com/address/${DISTRIBUTOR_ADDRESS}" target="_blank" rel="noopener">${DISTRIBUTOR_ADDRESS}</a>`;
  } else {
    $("distAddr").innerHTML = `<span class="warn">未設定（配布前は空でOK）</span>`;
    claimCard?.remove();
  }

  let provider, signer, account;
  async function ensureProvider(){ if(!window.ethereum) throw new Error("ウォレットが無い"); provider = new ethers.BrowserProvider(window.ethereum); return provider; }
  async function connect(){
    await ensureProvider();
    const accs = await provider.send("eth_requestAccounts", []);
    account = ethers.getAddress(accs[0]); signer = await provider.getSigner();
    acctEl.textContent = account; await checkNetwork();
  }
  async function checkNetwork(){
    const net = await provider.getNetwork();
    const isPoly = net.chainId === 137n;
    netStatus.innerHTML = isPoly ? `<span class="ok">Polygon(137)</span>` : `<span class="warn">別ネット: chainId=${net.chainId}</span>`;
    const tokenSet = isAddr(TOKEN_ADDRESS);
    watchBtn.disabled = !tokenSet; balanceBtn.disabled = !tokenSet; migrateBtn.disabled = !tokenSet;
    claimBtn.disabled = !isPoly || !isAddr(DISTRIBUTOR_ADDRESS);
  }
  async function switchToPolygon(){
    await ensureProvider();
    try { await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: POLYGON.chainId }]}); }
    catch(e){ if(e.code===4902) await window.ethereum.request({ method:"wallet_addEthereumChain", params:[POLYGON]}); else throw e; }
    await checkNetwork();
  }

  async function showBalance(){
    if(!signer) return;
    if(!isAddr(TOKEN_ADDRESS)) { balEl.innerHTML = `<span class="err">トークン未設定</span>`; return; }
    const token = new ethers.Contract(TOKEN_ADDRESS, ERC20_MIN_ABI, provider);
    const bal = await token.balanceOf(account);
    balEl.innerHTML = `JOMON 残高: <b>${bal.toString()}</b> 枚`;
  }

  async function watchAsset(){
    if(!window.ethereum) return alert("ウォレットが無い");
    if(!isAddr(TOKEN_ADDRESS)) return alert("トークン未設定。0x…を入れてから押せ");
    const ok = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: { address: TOKEN_ADDRESS, symbol: "JOMON", decimals: 0, image: "./jomon-coin-logo-256.png" }
      }
    });
    if (!ok) alert("追加がキャンセルされた");
  }

  let claimData=null, myEntry=null;
  async function loadClaims(){
    try{
      const res = await fetch("./claims.json", {cache:"no-store"});
      if(!res.ok) throw new Error("claims.jsonが見つからん");
      claimData = await res.json();
      if (claimData.chainId !== 137) throw new Error("chainIdが137じゃない");
      if (!isAddr(TOKEN_ADDRESS) || ethers.getAddress(claimData.token) !== ethers.getAddress(TOKEN_ADDRESS))
        throw new Error("claims.jsonのtokenアドレス不一致");
      const adr = account?.toLowerCase();
      myEntry = claimData.claims?.[adr];
      if(!myEntry) { claimStat.innerHTML = `<span class="warn">対象外 or 配布前</span>`; claimBtn.disabled = true; return; }
      claimStat.innerHTML = `amount=${myEntry.amount} / proof(${myEntry.proof.length})`;
      claimBtn.disabled = false;
    }catch(e){
      claimStat.innerHTML = `<span class="err">${e.message}</span>`; claimBtn.disabled = true;
    }
  }
  async function doClaim(){
    try{
      const distAddr = claimData?.distributor || DISTRIBUTOR_ADDRESS;
      if(!isAddr(distAddr)) throw new Error("ディストリビュータ未設定");
      const dist = new ethers.Contract(distAddr, DIST_ABI, signer);
      const claimed = await dist.isClaimed(account);
      if (claimed) { claimStat.innerHTML = `<span class="warn">すでに受取済み</span>`; return; }
      const tx = await dist.claim(ethers.toBigInt(myEntry.amount), myEntry.proof);
      claimStat.textContent = `送信中: ${tx.hash}`; await tx.wait();
      claimStat.innerHTML = `<span class="ok">完了</span>`; await showBalance();
    }catch(e){ claimStat.innerHTML = `<span class="err">${e.shortMessage||e.message}</span>`; }
  }

  async function doMigrate(){
    try{
      if(!isAddr(TOKEN_ADDRESS)) throw new Error("トークン未設定");
      if(!ethers.isAddress(newAddr.value)) throw new Error("新アドレスが不正");
      const token = new ethers.Contract(TOKEN_ADDRESS, ERC20_MIN_ABI, signer);
      const tx = await token.migrate(ethers.getAddress(newAddr.value));
      migStat.textContent = `送信中: ${tx.hash}`; await tx.wait();
      migStat.innerHTML = `<span class="ok">完了。新アドレスで残高確認しろ</span>`;
    }catch(e){ migStat.innerHTML = `<span class="err">${e.shortMessage||e.message}</span>`; }
  }

  const providerMaybe = window.ethereum ? new ethers.BrowserProvider(window.ethereum) : null;
  document.getElementById("connectBtn").onclick = connect;
  document.getElementById("switchBtn").onclick = switchToPolygon;
  document.getElementById("balanceBtn").onclick = showBalance;
  document.getElementById("watchBtn").onclick = watchAsset;
  document.getElementById("loadBtn").onclick = loadClaims;
  document.getElementById("claimBtn").onclick = doClaim;
  document.getElementById("migrateBtn").onclick = doMigrate;

  if (providerMaybe){
    window.ethereum.on('accountsChanged', ()=>location.reload());
    window.ethereum.on('chainChanged', ()=>location.reload());
    provider = providerMaybe; checkNetwork().catch(()=>{});
  }
})();
</script>
</body>
</html>
